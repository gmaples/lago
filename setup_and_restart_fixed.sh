#!/bin/bash

echo "=== Lago Container Restart Script (Fixed) ==="
echo

# Set the LAGO_PATH environment variable
export LAGO_PATH=/workspace/lago
echo "Setting LAGO_PATH=$LAGO_PATH"
echo

# Check if Docker daemon is running, start if not
echo "Checking Docker daemon status..."
if ! docker info >/dev/null 2>&1; then
    echo "Docker daemon not running. Attempting to start..."
    sudo service docker start
    
    # Wait for Docker to start
    echo "Waiting for Docker daemon to start..."
    for i in {1..30}; do
        if docker info >/dev/null 2>&1; then
            echo "Docker daemon started successfully!"
            break
        fi
        echo "Waiting... ($i/30)"
        sleep 2
    done
    
    if ! docker info >/dev/null 2>&1; then
        echo "ERROR: Failed to start Docker daemon"
        echo "Try running manually: sudo service docker start"
        exit 1
    fi
else
    echo "Docker daemon is already running."
fi
echo

# Create the .env file
echo "Creating .env file..."
cat > .env << 'EOF'
# Basic .env file for Lago development
LAGO_RSA_PRIVATE_KEY="LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdE5aWmFZOG1QOElaOGZFNjlqNUZuSkVKQVVhRThzVHJ3U2RUQUpSaGY2YVhvZzBuCjJRV2ZHV1JqK2lXYzRCOHo2Y0x2dEhxUUZxQ0g3aEkvNnc4Q2FZZ3RUUmh0UjZRS2JOanVxZkNLMTFnRVZsOVIKUHJvVVNGSGtKejNwVHpQYWZyVVk3d3NoS2FqQlJ2dGMrSjZCREk4bUN0cVVRNUNWbXhaTnBQQzhYTnp3ajN3NwpROEgxWHZOUElxc2VzcFIyQ2NSUDFYUFZ3d05kK3JEQ21TMzV3SnJOZFJOOGpVaXV0RlBHOVo1UGlGWU9WZmUrCjNlMi9xSEN6T0hWM3pGbzd0SlJkTk5KZ2dMejJ0Z25JcG9jMWtYOEFjNXYxZ3lLUVBwQTZEUGtLcm1vd2krQzcKRWhOMElFZUxUc0c3TEhJZHV2ZUpjTDNMa28wRGJQWnRBWXBWWndJREFRQUJBb0lCQUhOYTM1ais2SzJVNlJBQQpYakZHaDQxTVVqRnQzU2puVGt0eGxzYXJpejg2NWNjMGN2K2JQNXpIZUllK2hQOXhXbmJGWWdUengrV00yY3pOCjNyaHNGZHlLa3FubVphNGl1VlZyNWZYcWVTcFpldXdEbFFhTkFrbWk2SnBrY0Y4SHNiV2x5RXVnbzhjZnJqRjUKMnhQUWJZWXc0TTFjazZqc3dCMDZlSUFJV2NFSXpHQlJ0ZlJtY0J6SGNjdWFsZGRpY1h6L0RyTXpJdENlY0NyZgpxUnUzQlVvSTBldDYrZ1ZkTCtYSW5FcXJCZkdDbUtqdS9RTXhWSFNEWG5EOVdORFo2S20reDlNemZtczNOZ1ZMCnRYaVF1OUJPOVNZYnVOaDFMZFdUUEhGSUlOdHNieWlUc1B4OGVtQWJwNUdtWWZhNXBWWlBJR1pnSXZLY0tzeUEKa3JEWUZpRUNnWUVBMVU3ejE5UGdnWWp3YnVqYWFydHhyREJPVVJDVFR6Qjd0bjAzQ0hiUFZENm0zNDBuMGlsQwpOUkI5YmVXWk9GUmd5YUZ6NEZKOWEyTzBDdFBzSWNuUWprVERyYjk1QURxN0t4OWIzNWVNK2hvN1RwU3lzUytWCjFNRW8xTlMwTU1NTDJJSkNaeGRCN1VjYWR3dUZVN0NOQXp2cCtSaUNMSmlveVVoUXhLSWg2SjBDZ1lFQTJRUzYKcjFFOERJTkJXQ2J6am1QM2ZOT0p3bFFxQUtuZnI4WGZlblBIQkxUcXg3Q2pPMU5JWWlmT3NFWWkrQWNaK1FydApJOWtSNklZbnkyeUhzcXVqaFZnb3J4dGVWVGNrQUQrbDdoZFNPNEx5SStLKzMzZkNIZzJNSlFOOHF3VTVhQlZVCkNodWNwdzBOOW51YmJZOE5jcDVjdjVEUVJZSVNYWklOS1Y2cmVoTUNnWUVBdTlmOVcwU1Y4SVJPZWJoRzhpRVkKMlRYZFdXN3JLaytlNlkxL3ZCYlhzUzY4VVlEN3IvUVBzbGpOWGtCWmwxSkdNT0p6TEp1Q3lpYmp4ODc4UzgyNApTYjF0QlE4SStIVGdrMnpqU3QxVGQwaEVYTzhpQ3FVZ2dZYXE1WlF3N2t5TGpqM2dJUmR0SXJ6ZG8vMGFlOURiCkVMUVFtOTNtMWk3MmpqcExGZ1ZvbHFFQ2dZQXBKbW5yT3BhUzJ3ZW9aaTlZU1dPVFpKaGJhc0lRK0dGU0NhaWYKaUtjMGJSejNlNXQ4dmdyRzJOajQrMEowbjEzWE9UT09rQUs5UkIvUkJJN3Y2NW9RQ1cvK1VHU3BEWGJoN3JZNAprNVdkT0hKZlc5Q1RFYW9pM0t1RFhsNENkUnhieVNwMjNkM1E3cXVacCt5cjVsMVZkcWRyekFWUmV4WCtwcHA5ClNBWG1GUUtCZ1FDbVNGR2tYOCtOa1dydEQ2VzZXNmM1NjNqL0w2YVd5QTh0bDF4VE5TNHcyTzVRV3FldFd0S3IKUU9rdERvUGxOQkFBWWh5QUJJcGRSTVNZdmlxWGdSUHk2UjNJTStSMzV1ZkRPeWg5M0c1TTZMMm5PQzhtR3R0dwpkbG85R0VDZm1lYTkxZWlNSWdUZGdKajBHc1FCRlIrWlVNZ01oNGxaZ0I1YzBVcUtzNWNnU1E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQ=="
LAGO_DISABLE_SEGMENT=true
LAGO_DISABLE_WALLET_REFRESH=true
LAGO_REDIS_CACHE_PASSWORD=
LAGO_AWS_S3_ENDPOINT=
EOF

# Create the .env.development.default file
echo "Creating .env.development.default file..."
cat > .env.development.default << 'EOF'
# Default development environment variables for Lago
DATABASE_URL=postgresql://lago:changeme@db:5432/lago
POSTGRES_USER=lago
POSTGRES_PASSWORD=changeme
POSTGRES_DB=lago
POSTGRES_HOST=db
POSTGRES_PORT=5432
REDIS_URL=redis://redis:6379
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
RAILS_ENV=development
RAILS_LOG_TO_STDOUT=true
LAGO_API_URL=https://api.lago.dev
LAGO_FRONT_URL=https://app.lago.dev
SECRET_KEY_BASE=development-secret-key-base-that-is-at-least-30-characters-long
LAGO_RSA_PRIVATE_KEY=LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBdE5aWmFZOG1QOElaOGZFNjlqNUZuSkVKQVVhRThzVHJ3U2RUQUpSaGY2YVhvZzBuCjJRV2ZHV1JqK2lXYzRCOHo2Y0x2dEhxUUZxQ0g3aEkvNnc4Q2FZZ3RUUmh0UjZRS2JOanVxZkNLMTFnRVZsOVIKUHJvVVNGSGtKejNwVHpQYWZyVVk3d3NoS2FqQlJ2dGMrSjZCREk4bUN0cVVRNUNWbXhaTnBQQzhYTnp3ajN3NwpROEgxWHZOUElxc2VzcFIyQ2NSUDFYUFZ3d05kK3JEQ21TMzV3SnJOZFJOOGpVaXV0RlBHOVo1UGlGWU9WZmUrCjNlMi9xSEN6T0hWM3pGbzd0SlJkTk5KZ2dMejJ0Z25JcG9jMWtYOEFjNXYxZ3lLUVBwQTZEUGtLcm1vd2krQzcKRWhOMElFZUxUc0c3TEhJZHV2ZUpjTDNMa28wRGJQWnRBWXBWWndJREFRQUJBb0lCQUhOYTM1ais2SzJVNlJBQQpYakZHaDQxTVVqRnQzU2puVGt0eGxzYXJpejg2NWNjMGN2K2JQNXpIZUllK2hQOXhXbmJGWWdUengrV00yY3pOCjNyaHNGZHlLa3FubVphNGl1VlZyNWZYcWVTcFpldXdEbFFhTkFrbWk2SnBrY0Y4SHNiV2x5RXVnbzhjZnJqRjUKMnhQUWJZWXc0TTFjazZqc3dCMDZlSUFJV2NFSXpHQlJ0ZlJtY0J6SGNjdWFsZGRpY1h6L0RyTXpJdENlY0NyZgpxUnUzQlVvSTBldDYrZ1ZkTCtYSW5FcXJCZkdDbUtqdS9RTXhWSFNEWG5EOVdORFo2S20reDlNemZtczNOZ1ZMCnRYaVF1OUJPOVNZYnVOaDFMZFdUUEhGSUlOdHNieWlUc1B4OGVtQWJwNUdtWWZhNXBWWlBJR1pnSXZLY0tzeUEKa3JEWUZpRUNnWUVBMVU3ejE5UGdnWWp3YnVqYWFydHhyREJPVVJDVFR6Qjd0bjAzQ0hiUFZENm0zNDBuMGlsQwpOUkI5YmVXWk9GUmd5YUZ6NEZKOWEyTzBDdFBzSWNuUWprVERyYjk1QURxN0t4OWIzNWVNK2hvN1RwU3lzUytWCjFNRW8xTlMwTU1NTDJJSkNaeGRCN1VjYWR3dUZVN0NOQXp2cCtSaUNMSmlveVVoUXhLSWg2SjBDZ1lFQTJRUzYKcjFFOERJTkJXQ2J6am1QM2ZOT0p3bFFxQUtuZnI4WGZlblBIQkxUcXg3Q2pPMU5JWWlmT3NFWWkrQWNaK1FydApJOWtSNklZbnkyeUhzcXVqaFZnb3J4dGVWVGNrQUQrbDdoZFNPNEx5SStLKzMzZkNIZzJNSlFOOHF3VTVhQlZVCkNodWNwdzBOOW51YmJZOE5jcDVjdjVEUVJZSVNYWklOS1Y2cmVoTUNnWUVBdTlmOVcwU1Y4SVJPZWJoRzhpRVkKMlRYZFdXN3JLaytlNlkxL3ZCYlhzUzY4VVlEN3IvUVBzbGpOWGtCWmwxSkdNT0p6TEp1Q3lpYmp4ODc4UzgyNApTYjF0QlE4SStIVGdrMnpqU3QxVGQwaEVYTzhpQ3FVZ2dZYXE1WlF3N2t5TGpqM2dJUmR0SXJ6ZG8vMGFlOURiCkVMUVFtOTNtMWk3MmpqcExGZ1ZvbHFFQ2dZQXBKbW5yT3BhUzJ3ZW9aaTlZU1dPVFpKaGJhc0lRK0dGU0NhaWYKaUtjMGJSejNlNXQ4dmdyRzJOajQrMEowbjEzWE9UT09rQUs5UkIvUkJJN3Y2NW9RQ1cvK1VHU3BEWGJoN3JZNAprNVdkT0hKZlc5Q1RFYW9pM0t1RFhsNENkUnhieVNwMjNkM1E3cXVacCt5cjVsMVZkcWRyekFWUmV4WCtwcHA5ClNBWG1GUUtCZ1FDbVNGR2tYOCtOa1dydEQ2VzZXNmM1NjNqL0w2YVd5QTh0bDF4VE5TNHcyTzVRV3FldFd0S3IKUU9rdERvUGxOQkFBWWh5QUJJcGRSTVNZdmlxWGdSUHk2UjNJTStSMzV1ZkRPeWg5M0c1TTZMMm5PQzhtR3R0dwpkbG85R0VDZm1lYTkxZWlNSWdUZGdKajBHc1FCRlIrWlVNZ01oNGxaZ0I1YzBVcUtzNWNnU1E9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQ==
LAGO_ENCRYPTION_PRIMARY_KEY=development-encryption-primary-key-123456
LAGO_ENCRYPTION_DETERMINISTIC_KEY=development-encryption-deterministic-key
LAGO_ENCRYPTION_KEY_DERIVATION_SALT=development-derivation-salt-654321
LAGO_DISABLE_SEGMENT=true
LAGO_DISABLE_WALLET_REFRESH=true
LAGO_DISABLE_SIGNUP=false
LAGO_DISABLE_PDF_GENERATION=false
LAGO_SIDEKIQ_WEB=true
LAGO_USE_AWS_S3=false
LAGO_AWS_S3_ACCESS_KEY_ID=development-key
LAGO_AWS_S3_SECRET_ACCESS_KEY=development-secret
LAGO_AWS_S3_REGION=us-east-1
LAGO_AWS_S3_BUCKET=lago-development
LAGO_AWS_S3_ENDPOINT=
LAGO_USE_GCS=false
LAGO_GCS_PROJECT=
LAGO_GCS_BUCKET=
LAGO_FROM_EMAIL=
LAGO_SMTP_ADDRESS=
LAGO_SMTP_PORT=587
LAGO_SMTP_USERNAME=
LAGO_SMTP_PASSWORD=
LAGO_PDF_URL=http://pdf:3000
LAGO_REDIS_CACHE_URL=redis://redis:6379
LAGO_REDIS_CACHE_PASSWORD=
LAGO_OAUTH_PROXY_URL=https://proxy.getlago.com
GOOGLE_AUTH_CLIENT_ID=
GOOGLE_AUTH_CLIENT_SECRET=
LAGO_LICENSE=
LAGO_CREATE_ORG=false
LAGO_ORG_USER_PASSWORD=
LAGO_ORG_USER_EMAIL=
LAGO_ORG_NAME=
LAGO_ORG_API_KEY=
EOF

echo "Environment files created successfully!"
echo

# Stop any running containers
echo "Stopping existing containers..."
export LAGO_PATH=/workspace/lago
docker-compose -f docker-compose.dev.yml down --remove-orphans

echo
echo "Starting containers with fresh build..."
docker-compose -f docker-compose.dev.yml up --build -d

echo
echo "Waiting for containers to start..."
sleep 15

echo
echo "Container status:"
docker-compose -f docker-compose.dev.yml ps

echo
echo "Following logs (press Ctrl+C to stop watching):"
docker-compose -f docker-compose.dev.yml logs -f 